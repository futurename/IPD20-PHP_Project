{% extends "layouts/layout.html.twig" %}

{% block title %}
    Car selection
{% endblock title %}

{% block section %}
    <div>
        <div class="flex items-center mx-3 justify-between w-full">
            <span class="font-bold text-4xl text-dark">CHOOSE A VEHICLE CLASS</span>
            <div class="">
                <span class="font-bold">SORT BY</span>
                <select id="sortSelector">
                    <option>Featured</option>
                    <option name="lowToHigh">Price low to high</option>
                    <option name="highToLow">Price high to low</option>
                </select>
            </div>
        </div>
        <div class="flex flex-row ">
            <div class="bg-red-400 w-1/5 ">
                <div class="border-solid border-2 border-teal-800">
                    <p class="font-bold text-xl">Filters</p>

                    <div>
                        <div>
                            <span class="font-bold text-base">VEHICLE TYPE</span>
                            <span>Total from</span>
                        </div>

                        <ul>
                            <li>
                                <input type="checkbox" name="Car" class="vehicleFilter">
                                <span class="font-bold">Cars</span>
                                <span>CAD21</span>
                            </li>
                            <li>
                                <input type="checkbox" name="SUV" class="vehicleFilter">
                                <span class="font-bold">SUVs</span>
                                <span>CAD29</span>
                            </li>
                            <li>
                                <input type="checkbox" name="Van" class="vehicleFilter">
                                <span class="font-bold">Vans</span>
                                <span>CAD40</span>
                            </li>
                            <li>
                                <input type="checkbox" name="Truck" class="vehicleFilter">
                                <span class="font-bold">Trucks</span>
                                <span>CAD63</span>
                            </li>
                        </ul>
                    </div>

                    <div class="">
                        <p class="font-bold text-base">NUMBER OF PASSENGERS</p>
                        <ul>
                            <li>
                                <input type="checkbox" value="2" class="passFilter">
                                <span class="font-bold">2</span>
                                <span>CAD31</span>
                            </li>
                            <li>
                                <input type="checkbox" value="4" class="passFilter">
                                <span class="font-bold">4</span>
                                <span>CAD31</span>
                            </li>
                            <li>
                                <input type="checkbox" value="5" class="passFilter">
                                <span class="font-bold">5</span>
                                <span>CAD41</span>
                            </li>
                            <li>
                                <input type="checkbox" value="7" class="passFilter">
                                <span class="font-bold">7+</span>
                                <span>CAD70</span>
                            </li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-bold text-base">NUMBER OF BAGS</p>
                        <ul>
                            <li>
                                <input type="checkbox" value="3" class="bagFilter">
                                <span class="font-bold">3+</span>
                                <span>CAD21</span>
                            </li>
                            <li>
                                <input type="checkbox" value="4" class="bagFilter">
                                <span class="font-bold">4+</span>
                                <span>CAD21</span>
                            </li>
                            <li>
                                <input type="checkbox" value="5" class="bagFilter">
                                <span class="font-bold">5+</span>
                                <span>CAD40</span>
                            </li>
                            <li>
                                <input type="checkbox" value="7" class="bagFilter">
                                <span class="font-bold">7+</span>
                                <span>CAD80</span>
                            </li>
                        </ul>
                    </div>


                </div>
            </div>

            <div class="bg-blue-400 w-4/5 " id="vehicleList">
                {% for index,vehicle in allVehicles|sort((a,b)=> a.id <=> b.id) %}

                    <div class="flex hover:border-red-800 border-2 border-white flex-row vehicles {{ vehicle.category }} {{ "bags_" ~ vehicle.bags }} {{ "passengers_" ~ vehicle.passengers }}">
                        <div class="m-2 w-1/3">
                            <img src= {{ vehicle.photoPath }} width="250"/>
                        </div>
                        <div class="flex flex-col m-2 w-2/3">
                            <div>
                                <p class="font-bold text-2xl subtype">{{ vehicle.subtype }}</p>
                            </div>
                            <div class="flex flex-row">
                                <div class="w-1/2">
                                    <p>{{ vehicle.description }}</p><br>
                                    <i class="material-icons">directions_car</i>
                                    <span class="passengers">{{ vehicle.passengers }}</span> People<br>
                                    <i class="material-icons">work</i> <span class="bags">{{ vehicle.bags }}</span> Bags
                                </div>
                                <div>
                                    <p class="text-lg font-bold">CAD
                                        <span class="dailyPrice">{{ vehicle.dailyPrice }}</span></p><br><br>
                                    <form method="POST" action="/review_reserve/{{ vehicle.id }}">
                                        <input type="submit" value="SELECT"
                                               class="btSelect font-bold text-lg px-4 py-1 text-blue-800 bg-yellow-100 border-solid border-teal-800 border-2"/>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>

        function toggleVehicles() {
            var isAllUnchecked = $(".vehicleFilter:checked").length === 0;
            var passengerNum = $(".passFilter:checked").first().val() === undefined ? 0 : $(".passFilter:checked").first().val();
            var bagNum = $(".bagFilter:checked").first().val() === undefined ? 0 : $(".bagFilter:checked").first().val();

            $(".vehicles").hide();

            if (isAllUnchecked) {
                $(".vehicles").map(function (i, item) {
                    var curPassNum = item.querySelector(".passengers").innerText;
                    var curBagNum = item.querySelector(".bags").innerText;
                    if (curPassNum >= passengerNum && curBagNum >= bagNum) {
                        // alert("satisfied: " + curPassNum + ", " + curBagNum);
                        $(item).show();
                    }
                });
            } else {
                $(".vehicleFilter:checked").map(function () {
                    $(`.${this.name}`).map(function (i, item) {
                        var curPassNum = item.querySelector(".passengers").innerText;
                        var curBagNum = item.querySelector(".bags").innerText;
                        if (curPassNum >= passengerNum && curBagNum >= bagNum) {
                            // alert("satisfied: " + curPassNum + ", " + curBagNum);
                            $(item).show();
                        }
                    })

                })
            }
        }

        function sortLowToHigh(a, b) {
            return Number(a.querySelector(".dailyPrice").innerText) - Number(b.querySelector(".dailyPrice").innerText);
        }

        function sortHighToLow(a, b) {
            return Number(b.querySelector(".dailyPrice").innerText) - Number(a.querySelector(".dailyPrice").innerText);
        }

        function sortFeatured(a, b) {
            //alert(a.querySelector(".subtype").innerText < b.querySelector(".subtype").innerText);
            return a.querySelector(".subtype").innerText < b.querySelector(".subtype").innerText ? -1 : 1;
        }

        $(document).ready(function () {

            $("input[type=checkbox]").on("click", function () {
                toggleVehicles();
            })


            $("#sortSelector").change(function () {
                if ($(this).find("option:selected").attr("name") === "lowToHigh") {
                    //alert("low to high");
                    $(".vehicles").sort(sortLowToHigh).appendTo($("#vehicleList"));

                } else if ($(this).find("option:selected").attr("name") === "highToLow") {
                    //alert("high to low");
                    $(".vehicles").sort(sortHighToLow).appendTo($("#vehicleList"));
                } else {
                    //alert("featured");
                    $(".vehicles").sort(sortFeatured).appendTo($("#vehicleList"));
                }
            })
            /*
                        $(".btSelect").on("click", function () {
                            //alert($(this).parent().parent().parent().parent().attr("class"));
                            var parentElement = $(this).parent().parent().parent().parent();
                            var vehicleId = $(parentElement).find(".vehicleIndex").text();
                            //alert(vehicleId);
                            var vehiclesArray = {{ allVehicles|json_encode|raw }};
                var selVehicle = vehiclesArray[vehicleId];
                alert(JSON.stringify(selVehicle));

                $.ajax({ // FIXME: escape special characters using urlencode
                    url: "/review_reserve",
                    type: "POST",
                    dataType: "json",
                    data: selVehicle,
                    error: function (jqxhr, status, errorThrown) {
                        alert("AJAX error: " + jqxhr.responseText);
                    }
                })
            })*/


        })
    </script>

{% endblock section %}